/*! Shanti Kmaps Solr - v0.1.0 - 2018-01-17
* Copyright (c) 2018 ys2n; Licensed MIT */
!function(a,b,c,d){function e(a,b){this.state=h,this.init(a,b)}var f="inpage_search_state_store",g={prod:{preset:"prod",solrBase:"ss395824-us-east-1-aws.measuredsearch.com",solrPath:"/solr/",assetIndex:"kmassets",termIndex:"kmterms_prod"},dev:{preset:"dev",solrBase:"ss251856-us-east-1-aws.measuredsearch.com",solrPath:"/solr/",assetIndex:"kmassets_dev",termIndex:"kmterms_dev"},predev:{preset:"predev",solrBase:"ss251856-us-east-1-aws.measuredsearch.com",solrPath:"/solr/",assetIndex:"kmassets_predev",termIndex:"kmterms_predev"},test:{preset:"test",solrBase:"ss251856-us-east-1-aws.measuredsearch.com",solrPath:"/solr/",assetIndex:"kmassets_test",termIndex:"kmterms_test"},stage:{preset:"stage",solrBase:"ss395824-us-east-1-aws.measuredsearch.com",solrPath:"/solr/",assetIndex:"kmassets_stage",termIndex:"kmterms_stage"}},h={chosenFacets:[],page:0};e.prototype={processConfig:function(b,c){var d={pageSize:10},e=a.type(b);if("string"===e){if(!a.isPlainObject(g[b]))throw new Error("Unknown preset: "+b);d=a.extend({},d,g[b])}else"object"===e&&(d=a.extend({},d,b));return a.isPlainObject(c)&&(d=a.extend({},d,c)),console.log("processConfig returning: "+JSON.stringify(d)),d},assembleFacetConfigs:function(){var a=[{name:"kmaps_types",title:"Type",applies:function(a){return!0},getSolrFacetJSONString:function(){var a={kmaps_types:{limit:100,type:"terms",field:"tree"}};return JSON.stringify(a)},transform:function(a){var b=a.val,c=a.val,d=a.count,e="tree:"+a.val,f={id:"type-"+b,type:"Type",label:c,value:b,count:d,filterQuery:e};return f},handlebarsTemplate:""},{name:"feature_types",title:"Feature Types",applies:function(a){return!0},getSolrFacetJSONString:function(){var a={feature_types:{limit:100,type:"terms",field:"feature_type_id_i",facet:{feature_type_name_s:{field:"feature_type_name_s"}},domain:{blockChildren:"block_type:parent"}}};return JSON.stringify(a)},transform:function(a){var b="subjects-"+a.val,c=a.feature_type_name_s.buckets[0].val,d=(a.feature_type_name_s.buckets[0].count,a.count),e="{!parent which='block_type:parent'}feature_type_id_i:"+a.val,f={id:"feature_types-"+b,type:"Feature Type",label:c,value:b,count:d,filterQuery:e};return f},handlebarsTemplate:""},{name:"related_subjects",title:"Related Subjects",applies:function(a){return!0},getSolrFacetJSONString:function(){var a={related_subjects:{type:"terms",limit:100,prefix:"subjects-",field:"related_subjects_id_s",facet:{related_subjects_header_s:{field:"related_subjects_header_s"}},domain:{blockChildren:"block_type:parent"}}};return JSON.stringify(a)},transform:function(a){var b=a.val,c=a.related_subjects_header_s.buckets[0].val,d=a.count,e="{!parent which='block_type:parent'}related_subjects_id_s:"+b,f={id:"related_subjects-"+b,type:"Related Subject",label:c,value:b,count:d,filterQuery:e};return f},handlebarsTemplate:""},{name:"related_places",title:"Related Places",applies:function(a){return!0},getSolrFacetJSONString:function(){var a={related_places:{type:"terms",limit:100,prefix:"places-",field:"related_places_id_s",facet:{related_places_header_s:{field:"related_places_header_s"}},domain:{blockChildren:"block_type:parent"}}};return JSON.stringify(a)},transform:function(a){var b=a.val,c=a.related_places_header_s.buckets[0].val,d=a.count,e="{!parent which='block_type:parent'}related_places_id_s:"+b,f={id:"related_places-"+b,type:"Related Place",label:c,value:b,count:d,filterQuery:e};return f},handlebarsTemplate:""}];return a},init:function(b,c){var d=this;if(null!==sessionStorage.getItem(f))try{this.state=JSON.parse(sessionStorage.getItem(f))}catch(e){console.log("Error restoring in-page search state.  Discarding."),sessionStorage.setItem(f,JSON.stringify(h))}this.settings=this.processConfig(b,c),this.settings.facetConfigList=this.assembleFacetConfigs(),this.search().then(function(){null!==d.settings.afterInit&&"function"===a.type(d.settings.afterInit)&&d.settings.afterInit(d)})},search:function(b,c){var d=a.Deferred();"undefined"===a.type(c)&&(c=!0);var e=this,g=!1,h=a.extend({},this.state,this.processSearchArguments(b));try{this.executeSearch(h,this.settings,function(b){c&&!g&&(a.extend(e.state,b),e.update(),d.resolve(e),sessionStorage.setItem(f,JSON.stringify(e.state)))})}catch(i){console.error("ERROR:"+JSON.stringify(i)),d.reject(e)}return d.promise()},removeFacet:function(b){var c=null,d=a.type(b);return c="string"===d?this.state.facetHash[b]:b,"object"!==a.type(c)?console.error("facet spec "+b+" was not found or not an object"):delete this.state.filters[c.id],this.search()},selectFacet:function(b){var c=a.type(b);if("string"===c)b=this.state.facetHash[b];else if("object"!==c)throw new Error("selectFacet: Unknown argument type "+c+" or unknown facet name "+b);return this.search({chooseFacets:[b]},!0)},selectKmapId:function(a){return this.search({chooseKmaps:[a]})},removeKmapId:function(b){return a.isEmptyObject(this.state.filters.kmaps)||"string"!==a.type(this.state.filters.kmaps[b])?console.error("tried to delete non-existent "+b):delete this.state.filters.kmaps[b],a.isEmptyObject(this.state.filters.kmaps)&&delete this.state.filters.kmaps,this.search()},processSearchArguments:function(b,c){var d={},e=a.type(b);return"string"===e?a.extend(d,this.state,{searchString:b}):"object"===e&&a.extend(d,this.state,b),d},executeKMapSearch:function(b, c, e){var f=this,g={},h={},i={},j=b.start||0,k=c.pageSize;a.each(c.facetConfigList,function(c, d){var e=JSON.parse(d.getSolrFacetJSONString());d.applies(b)&&a.extend(!0,i,e),"function"===a.type(d.transform)&&(h[d.name]=d.transform,g[d.name]=d.title)});var l=JSON.stringify(i),m={};"object"===a.type(f.state.filters)&&(m=f.state.filters),"string"===a.type(b.searchString)&&(0===b.searchString.length?m.searchString&&delete m.searchString:m.searchString="header:"+b.searchString);var n=b.chooseFacets;null===n||"undefined"===a.type(n)?b.chooseFacets=[]:"array"!==a.type(n)&&(b.chooseFacets=[n]),a.each(b.chooseFacets,function(a,b){m[b.id]=b.filterQuery});var o=b.chooseKmaps;null===o||"undefined"===a.type(o)?b.chooseKmaps=[]:"array"!==a.type(o)&&(b.chooseKmaps=[o]),a.each(b.chooseKmaps,function(a,b){m.kmaps||(m.kmaps={}),m.kmaps[b]&&delete m.kmaps[b],m.kmaps[b]="ancestor_uids_generic:"+b});var p=a.map(m,function(b,c){if(a.isPlainObject(b)){var d=a.map(b,function(a){return a});0!==d.length&&(b="{!tag=kmaps}("+d.join(" OR ")+")")}return b}),q=f.getConfig();if(!q.solrBase)throw new Error("solrBase is not set!");if(!q.solrPath)throw new Error("solrPath is not set!");if(!q.termIndex)throw new Error("solrPath is not set!");var r="https://"+q.solrBase+q.solrPath+q.termIndex+"/query";console.log("requestUrl = "+r);var s={q:"block_type:parent",fl:"*",fq:p,facet:!0,"json.facet":l,start:j,rows:k};try{a.ajaxSettings.traditional=!0,a.ajax({type:"GET",cache:!1,url:r,data:s,dataType:"jsonp",jsonp:"json.wrf",timeout:3e4,error:function(a){console.error("ERRORING: "+JSON.stringify(a)),e(a)},beforeSend:function(){},success:function(b){var c=b.response,i=b.facets,j=f.state.facetHash?f.state.facetHash:{},k=f.state.filters||{},l=b.responseHeader.params.fq,m=a.type(l);if("undefined"===m)k={};else{if("array"!==m&&"string"!==m)throw new Error("unrecognized filters.  Must be string or array: "+JSON.stringify(l));"string"===m&&(l=[l]),a.each(l,function(a,b){var c=d;f.state&&f.state.facetHash&&(c=f.state.facetHash[b])})}for(var n in i)if("count"===n);else{i[n].title=g[n],i[n].name=n;for(var o in i[n].buckets){var p=i[n].buckets[o],q=h[n],r=q(p);i[n].buckets[o]=r,j[r.id]=r,j[r.filterQuery]=r}}var s=a.extend(f.state,{facets:i,facetHash:j,filters:k,results:c});e(s)},complete:function(){}})}catch(t){console.error(t)}},clearFacets:function(){var a=this.state.filters.searchString;return this.state.filters={searchString:a},this.search()},pageNext:function(){return this.page("next")},pagePrev:function(){return this.page("prev")},pageLast:function(){return this.page("last")},pageFirst:function(){return this.page(1)},pageCount:function(){var a=Number(this.state.results.numFound),b=this.settings.pageSize,c=Math.ceil(a/b);return c},page:function(b){var c=Number(this.state.results.numFound),e=Number(this.state.results.start),f=this.settings.pageSize,g=Math.ceil((e+1)/f),h=Math.ceil(c/f);if(console.groupCollapsed("page "+g+"/"+h+" results "+e+"/"+c),console.log(" numFound = "+c),console.log("    start = "+e),console.log("    size = "+f),console.log("     page = "+g),console.log("    pages = "+h),console.groupEnd(),b===d)return g;if(console.log("pg_number = "+JSON.stringify(b)),!a.isNumeric(b))if("first"===b)b=0;else if("last"===b)b=h;else if("next"===b)b=g+1;else{if("prev"!==b)throw new Error("recognized argument to page(): "+b);b=g-1}if(console.log("pg_number = "+JSON.stringify(b)),!a.isNumeric(b))throw new Error("Whoa, we should only be dealing with a number at this point!  Somehow pg_number = "+b);0>=b?b=1:b>h&&(b=h);var i=(b-1)*f;return console.log("Trying to go to start = "+i),this.search({start:i})},getState:function(){return this.state},getConfig:function(){return this.settings}},a.extend(e.prototype,{update:function(){console.group("update handler"),this.updateHandler(this.state),console.groupEnd("update handler")},updateHandler:function(b){"function"===a.type(this.settings.updateHandler)?this.settings.updateHandler(b):console.error("No update handler specified")}}),a.fn.kmapsSolr=function(a,b){return new e(a,b)},a.kmapsSolr=function(a,b){return new e(a,b)}}(jQuery,window,document);
